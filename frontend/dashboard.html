<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Results - Resume Advisor</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="container dashboard">
        <header class="header">
            <h1>Resume Analysis Results</h1>
            <button class="btn-secondary" id="newAnalysisBtn">Start New Analysis</button>
        </header>

        <main class="main-content">
            <!-- Overall Score Section -->
            <section class="score-section">
                <div class="overall-score">
                    <div class="score-label">Overall Fit Score</div>
                    <div class="score-value" id="overallScore">--</div>
                    <div class="score-gauge">
                        <div class="gauge-fill" id="gaugeFill"></div>
                    </div>
                </div>
                
                <div class="executive-summary">
                    <h3>Executive Summary</h3>
                    <p id="executiveSummary">Loading...</p>
                </div>
            </section>

            <!-- Action Buttons -->
            <div class="report-actions">
                <button class="btn-primary" id="downloadReportBtn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Download PDF Report
                </button>
                
                <button class="btn-secondary" id="generateOptimizedResumeBtn" style="margin-left: 12px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    Generate Optimized Resume
                </button>
            </div>
            
            <!-- Optimized Resume Display (initially hidden) -->
            <div id="optimizedResumeSection" style="display: none; margin-top: 30px;">
                <div style="background: #f8fafc; border: 2px solid #2563eb; border-radius: 8px; padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #1e40af;">✨ Your Optimized Resume</h3>
                        <button class="btn-primary" id="downloadOptimizedResumeBtn" style="font-size: 14px; padding: 8px 16px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            Download
                        </button>
                    </div>
                    <p style="color: #475569; margin-bottom: 15px; font-size: 14px;">
                        This resume has been optimized to align with the job description while maintaining authenticity.
                    </p>
                    <div style="background: white; border-radius: 6px; padding: 15px; max-height: 400px; overflow-y: auto;">
                        <pre id="optimizedResumeContent" style="white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.5; margin: 0;"></pre>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" data-tab="overview">Overview</button>
                <button class="tab" data-tab="skills">Skills Analysis</button>
                <button class="tab" data-tab="dimensions">Dimension Breakdown</button>
                <button class="tab" data-tab="recommendations">Recommendations</button>
            </div>

            <!-- Tab Content -->
            <div class="tab-content">
                <!-- Overview Tab -->
                <div class="tab-panel active" id="overview">
                    <div class="chart-container">
                        <canvas id="radarChart"></canvas>
                    </div>
                    
                    <div class="quick-stats">
                        <div class="stat-card">
                            <div class="stat-value" id="statOverlapping">--</div>
                            <div class="stat-label">Matching Skills</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statGaps">--</div>
                            <div class="stat-label">Skill Gaps</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statHighPriority">--</div>
                            <div class="stat-label">High Priority Gaps</div>
                        </div>
                    </div>
                </div>

                <!-- Skills Analysis Tab -->
                <div class="tab-panel" id="skills">
                    <div class="skills-section">
                        <h3 class="section-title">Overlapping Skills</h3>
                        <div class="badges-container" id="overlappingSkills">
                            <p class="empty-state">No overlapping skills found</p>
                        </div>
                    </div>
                    
                    <div class="skills-section">
                        <h3 class="section-title">Skill Gaps</h3>
                        <div id="skillGaps">
                            <p class="empty-state">No skill gaps identified</p>
                        </div>
                    </div>
                </div>

                <!-- Dimension Breakdown Tab -->
                <div class="tab-panel" id="dimensions">
                    <div id="dimensionCards"></div>
                </div>

                <!-- Recommendations Tab -->
                <div class="tab-panel" id="recommendations">
                    <div class="recommendations-content">
                        <h3>Prioritized Action Items</h3>
                        <p class="recommendations-intro">Based on your analysis, here are the key areas to focus on:</p>
                        <div id="recommendationsList"></div>
                    </div>
                </div>
            </div>
        </main>

        <footer class="footer">
            <p>Powered by OpenAI GPT-4 | Resume Advisor Platform</p>
        </footer>
    </div>

    <script>
        // Dashboard-specific JavaScript
        const urlParams = new URLSearchParams(window.location.search);
        const analysisId = urlParams.get('analysis_id');

        if (!analysisId) {
            alert('No analysis ID provided. Redirecting to home...');
            window.location.href = '/';
        } else {
            loadAnalysisResults(analysisId);
        }

        function loadAnalysisResults(analysisId) {
            fetch(`/api/analysis/${analysisId}`)
                .then(response => {
                    if (!response.ok) throw new Error('Analysis not found');
                    return response.json();
                })
                .then(data => {
                    displayResults(data.results);
                    window.currentAnalysisId = analysisId;
                })
                .catch(error => {
                    console.error('Error loading analysis:', error);
                    alert('Failed to load analysis results. Please try again.');
                    window.location.href = '/';
                });
        }

        function displayResults(results) {
            // Overall score
            const overallScore = results.overall_score;
            document.getElementById('overallScore').textContent = overallScore;
            
            // Color-code the score
            const scoreElement = document.getElementById('overallScore');
            if (overallScore >= 80) {
                scoreElement.style.color = '#22c55e';
            } else if (overallScore >= 60) {
                scoreElement.style.color = '#eab308';
            } else {
                scoreElement.style.color = '#ef4444';
            }
            
            // Gauge fill
            const gaugeFill = document.getElementById('gaugeFill');
            gaugeFill.style.width = `${overallScore}%`;
            gaugeFill.style.backgroundColor = scoreElement.style.color;
            
            // Executive summary
            document.getElementById('executiveSummary').textContent = results.executive_summary;
            
            // Quick stats
            document.getElementById('statOverlapping').textContent = results.overlapping_skills.length;
            document.getElementById('statGaps').textContent = results.skill_gaps.length;
            const highPriorityGaps = results.skill_gaps.filter(g => g.importance === 'high').length;
            document.getElementById('statHighPriority').textContent = highPriorityGaps;
            
            // Render radar chart
            renderRadarChart(results.dimensions);
            
            // Render overlapping skills
            renderOverlappingSkills(results.overlapping_skills);
            
            // Render skill gaps
            renderSkillGaps(results.skill_gaps);
            
            // Render dimension cards
            renderDimensionCards(results.dimensions);
            
            // Render recommendations
            renderRecommendations(results.overall_recommendations);
        }

        function renderRadarChart(dimensions) {
            const ctx = document.getElementById('radarChart').getContext('2d');
            
            const labels = Object.keys(dimensions);
            const scores = labels.map(dim => dimensions[dim].score);
            
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Score',
                        data: scores,
                        backgroundColor: 'rgba(37, 99, 235, 0.2)',
                        borderColor: 'rgba(37, 99, 235, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(37, 99, 235, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(37, 99, 235, 1)'
                    }]
                },
                options: {
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 20
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function renderOverlappingSkills(skills) {
            const container = document.getElementById('overlappingSkills');
            
            if (skills.length === 0) {
                container.innerHTML = '<p class="empty-state">No overlapping skills found</p>';
                return;
            }
            
            container.innerHTML = skills.map(skill => 
                `<span class="badge badge-success">${skill}</span>`
            ).join('');
        }

        function renderSkillGaps(gaps) {
            const container = document.getElementById('skillGaps');
            
            if (gaps.length === 0) {
                container.innerHTML = '<p class="empty-state">No skill gaps identified</p>';
                return;
            }
            
            container.innerHTML = gaps.map(gap => `
                <div class="gap-card gap-${gap.importance}">
                    <div class="gap-header">
                        <span class="gap-skill">${gap.skill}</span>
                        <span class="gap-importance ${gap.importance}">${gap.importance.toUpperCase()}</span>
                    </div>
                    <p class="gap-suggestion">${gap.suggestion}</p>
                </div>
            `).join('');
        }

        function renderDimensionCards(dimensions) {
            const container = document.getElementById('dimensionCards');
            
            container.innerHTML = Object.entries(dimensions).map(([name, data]) => {
                const scoreClass = data.score >= 80 ? 'high' : data.score >= 60 ? 'medium' : 'low';
                
                return `
                    <div class="dimension-card">
                        <div class="dimension-header">
                            <h3>${name}</h3>
                            <span class="dimension-score score-${scoreClass}">${data.score}/100</span>
                        </div>
                        <div class="dimension-body">
                            <h4>Analysis</h4>
                            <p>${data.analysis}</p>
                            
                            <h4>Recommendations</h4>
                            <ul class="recommendation-list">
                                ${data.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderRecommendations(recommendations) {
            const container = document.getElementById('recommendationsList');
            
            container.innerHTML = `
                <ol class="recommendations-list">
                    ${recommendations.map(rec => `<li>${rec}</li>`).join('')}
                </ol>
            `;
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                
                // Update active tab
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Update active panel
                document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                document.getElementById(tabName).classList.add('active');
            });
        });

        // Download report
        document.getElementById('downloadReportBtn').addEventListener('click', async () => {
            const btn = document.getElementById('downloadReportBtn');
            btn.disabled = true;
            btn.textContent = 'Generating...';
            
            try {
                // Generate report
                const generateResponse = await fetch(`/api/generate-report/${window.currentAnalysisId}`, {
                    method: 'POST'
                });
                
                if (!generateResponse.ok) throw new Error('Failed to generate report');
                
                const result = await generateResponse.json();
                
                // Download the PDF
                window.location.href = result.download_url;
                
                btn.textContent = 'Download PDF Report';
                btn.disabled = false;
            } catch (error) {
                console.error('Error downloading report:', error);
                alert('Failed to generate report. Please try again.');
                btn.textContent = 'Download PDF Report';
                btn.disabled = false;
            }
        });

        // New analysis button
        document.getElementById('newAnalysisBtn').addEventListener('click', () => {
            window.location.href = '/';
        });

        // Generate optimized resume
        document.getElementById('generateOptimizedResumeBtn').addEventListener('click', async () => {
            const btn = document.getElementById('generateOptimizedResumeBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span style="display: inline-flex; align-items: center;">Generating... ⏳</span>';
            
            try {
                // Generate optimized resume
                const response = await fetch('/api/generate-optimized-resume', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        analysis_id: window.currentAnalysisId
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to generate optimized resume');
                }
                
                const result = await response.json();
                
                // Display the optimized resume
                document.getElementById('optimizedResumeContent').textContent = result.optimized_resume;
                document.getElementById('optimizedResumeSection').style.display = 'block';
                
                // Store download URL for later
                window.optimizedResumeDownloadUrl = result.download_url;
                
                // Scroll to the optimized resume section
                document.getElementById('optimizedResumeSection').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'nearest' 
                });
                
                btn.innerHTML = originalText;
                btn.disabled = false;
                
                // Show success message
                alert('✨ Optimized resume generated successfully! You can now review and download it.');
            } catch (error) {
                console.error('Error generating optimized resume:', error);
                alert('Failed to generate optimized resume: ' + error.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // Download optimized resume
        document.getElementById('downloadOptimizedResumeBtn').addEventListener('click', () => {
            if (window.optimizedResumeDownloadUrl) {
                window.location.href = window.optimizedResumeDownloadUrl;
            } else {
                alert('Please generate the optimized resume first.');
            }
        });
    </script>
</body>
</html>

